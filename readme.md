# Advertising Platforms API

## Описание задачи

Рекламодатели часто хотят размещать рекламу в конкретном регионе (локации), например только в Московской области или
только в городе Малые Васюки. Этот сервис помогает подбирать рекламные площадки для заданного региона. Все рекламные
площадки перечислены в текстовом файле вместе с локациями, в которых они действуют.

### Пример входного файла:

```
Яндекс.Директ:/ru
Ревдинский рабочий:/ru/svrd/revda,/ru/svrd/pervik
Газета уральских москвичей:/ru/msk,/ru/permobl,/ru/chelobl
Крутая реклама:/ru/svrd
```

В корневой директории проекта находятся тестовые файлы с примерами входных данных:

- `success.txt` — корректный файл
- `partial_success.txt` — содержит как корректные, так и некорректные строки
- `failure.txt` — полностью некорректный файл

### Вложенность локаций

Локации вложены, если одна содержит другую как префикс. Например:

- `/ru/svrd/ekb` вложена в `/ru/svrd`
- `/ru/svrd` вложена в `/ru`
- `/ru/svrd/ekb` вложена в `/ru`

Чем меньше вложенность локации, тем более глобально действует рекламная площадка.

### Пример соответствия локаций и площадок:

- `/ru/msk` → Газета уральских москвичей, Яндекс.Директ
- `/ru/svrd` → Яндекс.Директ, Крутая реклама
- `/ru/svrd/revda` → Яндекс.Директ, Ревдинский рабочий, Крутая реклама
- `/ru` → Яндекс.Директ

---

## Функциональность API

Сервис предоставляет два REST API метода:

### 1. Загрузка рекламных площадок из файла

- **Метод:** `POST /api/advertising-platforms`
- **Формат запроса:** `multipart/form-data`
- **Параметры:** `File` (текстовый файл `.txt`)
- **Ответы:**
    - `200 OK` — файл успешно загружен
    - `400 Bad Request` — файл отсутствует или имеет некорректный формат
    - `500 Internal Server Error` — ошибка на сервере
    - `400 Bad Request` — если файл загружен частично, возвращает список некорректных строк

**Пример запроса:**

```sh
curl -X 'POST' \
  'http://localhost:5000/api/advertising-platforms' \
  -H 'accept: */*' \
  -H 'Content-Type: multipart/form-data' \
  -F 'File=@data.txt;type=text/plain'
```

### 2. Получение списка рекламных площадок для заданной локации

- **Метод:** `GET /api/advertising-platforms/{location}`
- **Параметры:** `{location}` — регион, например `/ru/svrd/revda`
- **Ответы:**
    - `200 OK` — список рекламных площадок
    - `400 Bad Request` — передан некорректный запрос
    - `404 Not Found` — локация найдена, но для нее нет рекламных площадок
    - `404 Not Found` — указанная локация не существует.
    - `500 Internal Server Error` — ошибка на сервере
    - `503 Service Unavailable` — Данные о рекламных площадках не загружены

**Пример запроса:**

```sh
curl -X 'GET' 'http://localhost:5000/api/advertising-platforms/%2Fru%2Fmsk'
```

**Пример ответа:**

```json
[
  "Газета уральских москвичей",
  "Яндекс.Директ"
]
```

---

## Запуск проекта

### Требования

- Docker (для контейнеризированного запуска)

### Запуск через Docker

```sh
docker-compose up --build
```

После запуска сервис будет доступен по адресу:  
[http://localhost:5000](http://localhost:5000)

Swagger-документация доступна по адресу:  
[http://localhost:5000/swagger/index.html](http://localhost:5000/swagger/index.html)

---

## Рецензия от проверяющего и внесенные исправления

### Замечания проверяющего:

1. **Очистка коллекции при повторной загрузке файла**: повторные загрузки файла приводили к ошибкам в поисковых запросах во время обработки файла, так как коллекция очищалась до завершения загрузки.
2. **Отсутствие логирования**: логирование запросов и обработки данных отсутствовало.
3. **Не было глобальной обработки ошибок**: ошибки обрабатывались на уровне контроллеров, но не глобально.

### Внесенные исправления:

1. **Использование буферного словаря**: теперь данные загружаются в буферный словарь, который заменяет основной только после успешного завершения загрузки.
2. **Добавлено логирование**: теперь API логирует загрузку файлов, их обработку, а также запросы к сервису.
3. **Реализован Global Exception Handler**: исключения теперь обрабатываются централизованно через middleware, что улучшает контроль ошибок и упрощает код контроллеров.
4. **Юнит-тесты обновлены**: тесты переработаны для корректной работы с исключениями и тестирования ожидаемых ошибок.

